{
  "settings": {
    "stopOnFirstMatchPerColumn": false,
    "defaultCulture": "en-US",
    "preferFirstAssignment": true
  },
  "lookups": {
    "brands": {
      "D&G": "Dolce & Gabbana",
      "DOLCE & GABBANA": "Dolce & Gabbana",
      "DOLCE AND GABBANA": "Dolce & Gabbana"
    },
    "concentrations": {
      "EDP": "Eau de Parfum",
      "EDT": "Eau de Toilette",
      "EDC": "Eau de Cologne"
    },
    "genders": {
      "WOM": "Women",
      "W": "Women",
      "MEN": "Men",
      "M": "Men",
      "UNISEX": "Unisex",
      "U": "Unisex",
      "F": "Women"
    },
    "types": {
      "REG": "Regular",
      "REGULAR": "Regular",
      "REGULARS": "Regular"
    }
  },
  "columns": [
    {
      "column": "A",
      "rules": [
        {
          "id": "a-type-brand-ref",
          "priority": 1,
          "type": "Pipeline",
          "steps": [
            { "op": "NormalizeWhitespace" },
            {
              "op": "RegexExtract",
              "pattern": "^(?<type>[^:]+):(?<brandRaw>[^:]+):(?<ref>[^:\\s]+)$",
              "options": "IgnoreCase"
            },
            {
              "op": "Lookup",
              "table": "types",
              "in": "type",
              "out": "typeNorm"
            },
            {
              "op": "Lookup",
              "table": "brands",
              "in": "brandRaw",
              "out": "brandNorm"
            },
            {
              "op": "Assign",
              "map": {
                "typeNorm->Type": "",
                "brandNorm->Brand": "",
                "ref->Ref": ""
              }
            }
          ]
        }
      ]
    },
    {
      "column": "B",
      "rules": [
        {
          "id": "b-ref-direct",
          "priority": 1,
          "type": "MapValue",
          "assign": { "raw->Ref": "trim" }
        }
      ]
    },
    {
      "column": "C",
      "rules": [
        {
          "id": "c-ean-direct",
          "priority": 1,
          "type": "MapValue",
          "assign": { "raw->EAN": "trim" }
        }
      ]
    },
    {
      "column": "D",
      "rules": [
        {
          "id": "d-type-normalize",
          "priority": 1,
          "type": "Pipeline",
          "steps": [
            { "op": "NormalizeWhitespace" },
            {
              "op": "RegexExtract",
              "pattern": "^(?<type>[^\\s]+)$",
              "options": "IgnoreCase"
            },
            {
              "op": "Lookup",
              "table": "types",
              "in": "type",
              "out": "typeNorm"
            },
            {
              "op": "Assign",
              "map": { "typeNorm->Type": "" }
            }
          ]
        }
      ]
    },
    {
      "column": "E",
      "rules": [
        {
          "id": "e-perfume-description",
          "priority": 1,
          "type": "Pipeline",
          "steps": [
            {
              "op": "UnicodeNormalize",
              "form": "FormKC"
            },
            { "op": "NormalizeWhitespace" },
            {
              "op": "RegexExtract",
              "pattern": "^(?<brand>\\S+)\\s+(?<series>.+?)\\s+(?<gender>Wom|Women|Men|Unisex|M|F|W)\\s+(?<concentration>EDP|EDT|EDC)\\s*\\((?<size>\\d+(?:[\\.,]\\d+)?)\\s*(?<unit>ml|mL|ML|oz|g)\\)$",
              "options": "IgnoreCase"
            },
            {
              "op": "Lookup",
              "table": "genders",
              "in": "gender",
              "out": "genderNorm"
            },
            {
              "op": "Lookup",
              "table": "concentrations",
              "in": "concentration",
              "out": "concentrationFull"
            },
            {
              "op": "NumberParse",
              "from": "size",
              "to": "sizeNum"
            },
            {
              "op": "UnitParse",
              "valueFrom": "sizeNum",
              "unitFrom": "unit",
              "valueOut": "SizeValue",
              "unitOut": "SizeUnit"
            },
            {
              "op": "Assign",
              "map": {
                "series->Series": "",
                "genderNorm->Gender": "",
                "concentrationFull->Concentration": "",
                "SizeValue->SizeValue": "",
                "SizeUnit->SizeUnit": ""
              }
            }
          ]
        }
      ]
    },
    {
      "column": "F",
      "rules": [
        {
          "id": "f-quantity-number",
          "priority": 1,
          "type": "MultiCaptureRegex",
          "pattern": "^(?<qty>\\d+)$",
          "assign": { "qty->Quantity": "decimal" }
        }
      ]
    },
    {
      "column": "G",
      "rules": [
        {
          "id": "g-price-with-optional-currency",
          "priority": 1,
          "type": "MultiCaptureRegex",
          "pattern": "^(?<amount>\\d+(?:[\\.,]\\d{1,2})?)(?:\\s*(?<currency>[A-Z]{3}|₪|€|\\$))?$",
          "assign": {
            "amount->Price": "decimal",
            "currency->Currency": "currencyNormalize"
          }
        }
      ]
    }
  ]
}
